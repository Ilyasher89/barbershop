<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .time-slot-btn {
            padding: 6px 3px;
            font-size: 0.85rem;
            margin: 1px;
            width: 100%;
            min-height: 40px;
        }
        .time-slot-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .time-slot-btn.active {
            background-color: #0d6efd !important;
            color: white !important;
            border-color: #0d6efd !important;
        }
        .time-table th {
            background-color: #f8f9fa;
            font-size: 0.9rem;
            padding: 8px 4px;
        }
        .time-table td {
            padding: 2px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1>üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h1>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
    <div th:if="${errorMessage != null}" class="alert alert-danger">
        <strong>‚ùå –û—à–∏–±–∫–∞!</strong> <span th:text="${errorMessage}"></span>
    </div>
    <div th:if="${param.success != null}" class="alert alert-success">
        ‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!
    </div>

    <form th:action="@{/client/appointments/new}" method="post" th:object="${appointmentRequest}">
        <!-- –í—ã–±–æ—Ä –º–∞—Å—Ç–µ—Ä–∞ –∏ —É—Å–ª—É–≥–∏ -->
        <div class="mb-3">
            <label class="form-label">–ú–∞—Å—Ç–µ—Ä –∏ —É—Å–ª—É–≥–∞:</label>
            <select class="form-select" th:field="*{barberServiceId}" required id="barberServiceSelect">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞ –∏ —É—Å–ª—É–≥—É --</option>
                <optgroup th:each="barber : ${barbers}"
                          th:label="${barber.user.firstName} + ' ' + ${barber.user.lastName}">
                    <option th:each="service : ${barber.barberServices}"
                            th:value="${service.id}"
                            th:text="${service.service.name} + ' (' + ${service.actualPrice} + ' —Ä—É–±., ' + ${service.actualDurationMinutes} + ' –º–∏–Ω)'">
                    </option>
                </optgroup>
            </select>
        </div>

        <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
        <div class="mb-3">
            <label class="form-label">–î–∞—Ç–∞:</label>
            <input type="date" class="form-control" id="dateSelect" required>
        </div>

        <!-- –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –¢–ê–ë–õ–ò–¶–ï–ô -->
        <div class="mb-3">
            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:</label>
            <div class="table-responsive">
                <table class="table table-bordered time-table">
                    <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –∑–∞–≥–æ–ª–æ–≤–∫–∏ -->
                    <tr>
                        <th>10:00-12:00</th>
                        <th>12:00-14:00</th>
                        <th>14:00-16:00</th>
                        <th>16:00-18:00</th>
                    </tr>
                    <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: —É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–ª–æ—Ç—ã -->
                    <tr>
                        <!-- 10:00-12:00 -->
                        <td>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="10:00" onclick="selectTimeSlot(this)">10:00</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="10:15" onclick="selectTimeSlot(this)">10:15</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="10:30" onclick="selectTimeSlot(this)">10:30</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="10:45" onclick="selectTimeSlot(this)">10:45</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="11:00" onclick="selectTimeSlot(this)">11:00</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="11:15" onclick="selectTimeSlot(this)">11:15</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="11:30" onclick="selectTimeSlot(this)">11:30</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="11:45" onclick="selectTimeSlot(this)">11:45</button>
                        </td>
                        <!-- 12:00-14:00 -->
                        <td>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="12:00" onclick="selectTimeSlot(this)">12:00</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="12:15" onclick="selectTimeSlot(this)">12:15</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="12:30" onclick="selectTimeSlot(this)">12:30</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="12:45" onclick="selectTimeSlot(this)">12:45</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="13:00" onclick="selectTimeSlot(this)">13:00</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="13:15" onclick="selectTimeSlot(this)">13:15</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="13:30" onclick="selectTimeSlot(this)">13:30</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="13:45" onclick="selectTimeSlot(this)">13:45</button>
                        </td>
                        <!-- 14:00-16:00 -->
                        <td>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="14:00" onclick="selectTimeSlot(this)">14:00</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="14:15" onclick="selectTimeSlot(this)">14:15</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="14:30" onclick="selectTimeSlot(this)">14:30</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="14:45" onclick="selectTimeSlot(this)">14:45</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="15:00" onclick="selectTimeSlot(this)">15:00</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="15:15" onclick="selectTimeSlot(this)">15:15</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="15:30" onclick="selectTimeSlot(this)">15:30</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="15:45" onclick="selectTimeSlot(this)">15:45</button>
                        </td>
                        <!-- 16:00-18:00 -->
                        <td>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="16:00" onclick="selectTimeSlot(this)">16:00</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="16:15" onclick="selectTimeSlot(this)">16:15</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="16:30" onclick="selectTimeSlot(this)">16:30</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="16:45" onclick="selectTimeSlot(this)">16:45</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="17:00" onclick="selectTimeSlot(this)">17:00</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="17:15" onclick="selectTimeSlot(this)">17:15</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="17:30" onclick="selectTimeSlot(this)">17:30</button><br>
                            <button type="button" class="btn btn-outline-primary time-slot-btn" data-time="17:45" onclick="selectTimeSlot(this)">17:45</button>
                        </td>
                    </tr>
                </table>
            </div>
            <small class="text-muted">–†–∞–±–æ—á–∏–µ —á–∞—Å—ã: 10:00 - 18:00, —Å–ª–æ—Ç—ã –ø–æ 15 –º–∏–Ω—É—Ç</small>
        </div>

        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ -->
        <input type="hidden" th:field="*{appointmentDateTime}" id="appointmentDateTimeInput">

        <!-- –ö–Ω–æ–ø–∫–∞ –ó–ê–ü–ò–°–ê–¢–¨–°–Ø –ø—Ä—è–º–æ –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π -->
        <div class="mt-4">
            <button type="submit" class="btn btn-success btn-lg w-100">
                <i class="bi bi-calendar-check"></i> –ó–ê–ü–ò–°–ê–¢–¨–°–Ø
            </button>
            <div class="text-center mt-2">
                <a href="/client/appointments" class="btn btn-link">–∏–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–∏ –∑–∞–ø–∏—Å–∏</a>
            </div>
        </div>
    </form>
</div>

<script>
    let selectedDate = '';
    let selectedTime = '';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤—Ç—Ä–∞—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.addEventListener('DOMContentLoaded', function() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);

        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
        const day = String(tomorrow.getDate()).padStart(2, '0');

        selectedDate = `${year}-${month}-${day}`;
        const dateSelect = document.getElementById('dateSelect');
        dateSelect.value = selectedDate;

        // –ú–∏–Ω–∏–º—É–º - —Å–µ–≥–æ–¥–Ω—è
        const today = new Date().toISOString().split('T')[0];
        dateSelect.min = today;

        // –ú–∞–∫—Å–∏–º—É–º +30 –¥–Ω–µ–π
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 30);
        const maxDateStr = maxDate.toISOString().split('T')[0];
        dateSelect.max = maxDateStr;

        // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ—Ç—ã
        dateSelect.addEventListener('change', function() {
            selectedDate = this.value;
            updateDateTime();
            checkAvailableSlots();
        });

        // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ —Ç–æ–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ—Ç—ã
        document.getElementById('barberServiceSelect').addEventListener('change', function() {
            if (selectedDate) {
                checkAvailableSlots();
            }
        });

        updateDateTime();
        checkAvailableSlots();
    });

    // –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
    function selectTimeSlot(button) {
        if (button.disabled) return;

        document.querySelectorAll('.time-slot-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });

        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-primary', 'active');
        selectedTime = button.dataset.time;
        updateDateTime();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
    function updateDateTime() {
        if (selectedDate && selectedTime) {
            const dateTimeString = `${selectedDate}T${selectedTime}`;
            document.getElementById('appointmentDateTimeInput').value = dateTimeString;
            console.log("–í—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è:", dateTimeString);
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤
    async function checkAvailableSlots() {
        const barberServiceId = document.getElementById('barberServiceSelect').value;
        if (!barberServiceId || !selectedDate) return;

        // –í—Ä–µ–º–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.time-slot-btn').forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        });

        try {
            const response = await fetch(
                `/client/api/occupied-slots?barberServiceId=${barberServiceId}&date=${selectedDate}`
            );
            const occupiedSlots = await response.json();
            console.log("–ó–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã:", occupiedSlots);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                const time = btn.dataset.time;
                const isOccupied = occupiedSlots.includes(time);

                btn.disabled = isOccupied;
                btn.textContent = time;

                if (isOccupied) {
                    btn.classList.remove('btn-outline-primary', 'btn-primary', 'active');
                    btn.classList.add('btn-outline-secondary');
                    btn.title = '–í—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ';
                } else {
                    btn.classList.remove('btn-outline-secondary', 'btn-primary', 'active');
                    btn.classList.add('btn-outline-primary');
                    btn.title = '';
                }

                // –ï—Å–ª–∏ —ç—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
                if (time === selectedTime && !isOccupied) {
                    btn.classList.add('btn-primary', 'active');
                }
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–ª–æ—Ç–æ–≤:', error);
            // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.disabled = false;
                btn.textContent = btn.dataset.time;
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-outline-primary');
            });
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    document.querySelector('form').addEventListener('submit', function(event) {
        if (!selectedDate || !selectedTime) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è!');
            event.preventDefault();
            return;
        }

        const selectedBtn = document.querySelector(`.time-slot-btn[data-time="${selectedTime}"]`);
        if (selectedBtn && selectedBtn.disabled) {
            alert('–í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞–ª–æ –∑–∞–Ω—è—Ç–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.');
            event.preventDefault();
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>